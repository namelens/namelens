# yamllint disable rule:document-start
# yamllint disable rule:truthy
# yamllint disable rule:line-length
#
# Release Workflow
# Builds CGO-enabled binaries on native runners and uploads to a DRAFT GitHub
# Release. The release is NOT published by this workflow.
#
# After CI completes, signing and publishing is done manually:
#   make release-download    # Download binaries from draft release
#   make release-checksums   # Generate SHA256SUMS
#   make release-sign        # Sign checksums with minisign
#   make release-upload      # Upload checksums/signature and publish release
#
# go-libsql requires CGO and only supports:
#   - linux/amd64, linux/arm64 (glibc)
#   - darwin/arm64 (Apple Silicon only - no Intel Mac support)
#
name: Release
on:
  push:
    tags:
      - "v*"

# Default posture: draft -> sign -> undraft (publishing is separate)
permissions:
  contents: read
env:
  BINARY_NAME: namelens
jobs:
  # Validate VERSION matches tag
  validate:
    runs-on: ubuntu-latest-x64-s
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0
      - name: Validate VERSION matches tag
        id: version
        run: |
          set -euo pipefail
          FILE_VERSION=$(cat VERSION)
          TAG_VERSION=${GITHUB_REF_NAME#v}
          echo "VERSION file: $FILE_VERSION"
          echo "Git tag: $TAG_VERSION"
          if [ "$FILE_VERSION" != "$TAG_VERSION" ]; then
            MSG="VERSION ($FILE_VERSION) != tag ($TAG_VERSION)"
            echo "::error::$MSG"
            exit 1
          fi
          echo "version=$FILE_VERSION" >> "$GITHUB_OUTPUT"
  # Build Linux binaries (native runners for CGO)
  build-linux:
    needs: validate
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest-x64-s
          - arch: arm64
            runner: ubuntu-latest-arm64-s
    runs-on: ${{ matrix.runner }}
    env:
      VERSION: ${{ needs.validate.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.x"
      - name: Build binary
        run: |
          COMMIT=$(git rev-parse --short HEAD)
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          LDFLAGS="-X main.version=${VERSION} -X main.commit=${COMMIT} -X main.buildDate=${BUILD_DATE} -s -w"

          mkdir -p dist
          CGO_ENABLED=1 GOOS=linux GOARCH=${{ matrix.arch }} \
            go build -ldflags="${LDFLAGS}" -trimpath \
            -o "dist/${BINARY_NAME}-linux-${{ matrix.arch }}" \
            "./cmd/${BINARY_NAME}"

          file "dist/${BINARY_NAME}-linux-${{ matrix.arch }}"
          "dist/${BINARY_NAME}-linux-${{ matrix.arch }}" version || true
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BINARY_NAME }}-linux-${{ matrix.arch }}
          path: dist/${{ env.BINARY_NAME }}-linux-${{ matrix.arch }}
          retention-days: 1
  # Build macOS binary (native runner for CGO)
  # Note: go-libsql only supports darwin/arm64 (Apple Silicon)
  build-darwin:
    needs: validate
    runs-on: macos-latest
    env:
      VERSION: ${{ needs.validate.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.x"
      - name: Build binary
        run: |
          COMMIT=$(git rev-parse --short HEAD)
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          LDFLAGS="-X main.version=${VERSION} -X main.commit=${COMMIT} -X main.buildDate=${BUILD_DATE} -s -w"

          mkdir -p dist
          CGO_ENABLED=1 GOOS=darwin GOARCH=arm64 \
            go build -ldflags="${LDFLAGS}" -trimpath \
            -o "dist/${BINARY_NAME}-darwin-arm64" \
            "./cmd/${BINARY_NAME}"

          file "dist/${BINARY_NAME}-darwin-arm64"
          "dist/${BINARY_NAME}-darwin-arm64" version || true
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BINARY_NAME }}-darwin-arm64
          path: dist/${{ env.BINARY_NAME }}-darwin-arm64
          retention-days: 1
  # Create draft release with all artifacts (unsigned - signing is manual)
  publish:
    name: Publish Release
    needs: [validate, build-linux, build-darwin]
    runs-on: ubuntu-latest-x64-s
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4.1.3
        with:
          path: release
          merge-multiple: true
      - name: List release files
        run: ls -la release/
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          generate_release_notes: true
          draft: true
          body: |
            ## namelens v${{ needs.validate.outputs.version }}

            Name availability checker for domains, package registries, and social handles.

            ### Verification

            **Note:** This release is unsigned. Signed checksums will be uploaded after manual signing.

            Once signed artifacts are available:
            ```bash
            minisign -Vm SHA256SUMS -p namelens-minisign.pub
            sha256sum -c SHA256SUMS --ignore-missing
            ```

            ### Platform Support

            | Binary | Platform |
            |--------|----------|
            | `namelens-linux-amd64` | Linux x86_64 (glibc) |
            | `namelens-linux-arm64` | Linux ARM64 (glibc) |
            | `namelens-darwin-arm64` | macOS Apple Silicon |

            **Note:** macOS Intel is not supported due to go-libsql limitations.
